@@ -8,18 +8,20 @@
     use function_space_mod, only : function_space_type
     use mesh_mod, only : mesh_type
     use function_space_collection_mod, only : function_space_collection
-    use combine_multidata_field_kernel_mod, only : combine_multidata_field_kernel_type
-    use adj_combine_multidata_field_kernel_mod, only : adj_combine_multidata_field_kernel_type
+    use sci_combine_multidata_field_kernel_mod, only : combine_multidata_field_kernel_type
+    use adj_sci_combine_multidata_field_kernel_mod, only : adj_combine_multidata_field_kernel_type
     use finite_element_config_mod, only : element_order_h, element_order_v
-    use fs_continuity_mod, only : w0
+    use fs_continuity_mod, only : w3
     use constants_mod, only : i_def, l_def, r_def
     use setop_random_kernel_mod, only : setop_random_kernel_type
-    use log_mod, only : log_event, log_level_error, log_level_info, log_scratch_space
+    use log_mod, only : log_event, log_level_error, log_level_info, log_scratch_space, log_level_debug
     real(kind=r_def), parameter :: overall_tolerance = 1500.0_r_def
     type(mesh_type), pointer, intent(in) :: mesh
     type(field_type), dimension(3), intent(in), optional :: chi
     type(field_type), intent(in), optional :: panel_id
-    TYPE(function_space_type), POINTER :: vector_space_w0_ptr
+    TYPE(function_space_type), POINTER :: vector_space_w3_ptr
+    TYPE(function_space_type), POINTER :: vector_space_w3_n1_ptr
+    TYPE(function_space_type), POINTER :: vector_space_w3_n2_ptr
     type(field_type) :: field_out
     integer(kind=i_def) :: n
     type(field_type) :: field1_in
@@ -27,16 +29,15 @@
     type(field_type) :: field2_in
     integer(kind=i_def) :: n2
     logical(kind=l_def) :: ndata_first
-    integer(kind=i_def) :: n_input
-    integer(kind=i_def) :: n1_input
-    integer(kind=i_def) :: n2_input
-    logical(kind=l_def) :: ndata_first_input
     type(field_type) :: field_out_input
     type(field_type) :: field1_in_input
     type(field_type) :: field2_in_input
     real(kind=r_def) :: field_out_inner_prod
     real(kind=r_def) :: field1_in_inner_prod
     real(kind=r_def) :: field2_in_inner_prod
+    real(kind=r_def) :: field_out_sf
+    real(kind=r_def) :: field1_in_sf
+    real(kind=r_def) :: field2_in_sf
     real(kind=r_def) :: inner1
     real(kind=r_def) :: field_out_field_out_input_inner_prod
     real(kind=r_def) :: field1_in_field1_in_input_inner_prod
@@ -44,22 +45,25 @@
     real(kind=r_def) :: inner2
     real(kind=r_def) :: MachineTol
     real(kind=r_def) :: relative_diff
+    real(kind=r_def), parameter :: eps = 1.0e-30_r_def
 
-    vector_space_w0_ptr => function_space_collection%get_fs(mesh,element_order_h,element_order_v,w0)
-    call field_out%initialise(vector_space=vector_space_w0_ptr, name='field_out')
-    call field1_in%initialise(vector_space=vector_space_w0_ptr, name='field1_in')
-    call field2_in%initialise(vector_space=vector_space_w0_ptr, name='field2_in')
-    call field_out_input%initialise(vector_space=vector_space_w0_ptr, name='field_out_input')
-    call field1_in_input%initialise(vector_space=vector_space_w0_ptr, name='field1_in_input')
-    call field2_in_input%initialise(vector_space=vector_space_w0_ptr, name='field2_in_input')
-    n = 1_i_def
-    n_input = n
-    n1 = 1_i_def
-    n1_input = n1
-    n2 = 1_i_def
-    n2_input = n2
+    n = 6_i_def
+    n1 = 4_i_def
+    n2 = 2_i_def
     ndata_first = .false._l_def
-    ndata_first_input = ndata_first
+    vector_space_w3_ptr => function_space_collection%get_fs(mesh, element_order_h, element_order_v, &
+                                                            w3, n, ndata_first = ndata_first)
+    vector_space_w3_n1_ptr => function_space_collection%get_fs(mesh, element_order_h, element_order_v, &
+                                                               w3, n1, ndata_first = ndata_first)
+    vector_space_w3_n2_ptr => function_space_collection%get_fs(mesh, element_order_h, element_order_v, &
+                                                               w3, n2, ndata_first = ndata_first)
+    call field_out%initialise(vector_space=vector_space_w3_ptr, name='field_out')
+    call field1_in%initialise(vector_space=vector_space_w3_n1_ptr, name='field1_in')
+    call field2_in%initialise(vector_space=vector_space_w3_n2_ptr, name='field2_in')
+    call field_out_input%initialise(vector_space=vector_space_w3_ptr, name='field_out_input')
+    call field1_in_input%initialise(vector_space=vector_space_w3_n1_ptr, name='field1_in_input')
+    call field2_in_input%initialise(vector_space=vector_space_w3_n2_ptr, name='field2_in_input')
+
     field_out_inner_prod = 0.0_r_def
     field1_in_inner_prod = 0.0_r_def
     field2_in_inner_prod = 0.0_r_def
@@ -69,13 +73,24 @@
 &combine_multidata_field_kernel_type(field_out, n, field1_in, n1, field2_in, n2, ndata_first), &
 &x_innerproduct_x(field_out_inner_prod, field_out), x_innerproduct_x(field1_in_inner_prod, field1_in), &
 &x_innerproduct_x(field2_in_inner_prod, field2_in))
+    write( log_scratch_space, * ) "adjt_sci_combine_multidata_field_alg inner products:"
+    call log_event( log_scratch_space, log_level_debug )
+    write( log_scratch_space, * ) "field1_in inner product = ", field1_in_inner_prod
+    call log_event( log_scratch_space, log_level_debug )
+    write( log_scratch_space, * ) "field2_in inner product = ", field2_in_inner_prod
+    call log_event( log_scratch_space, log_level_debug )
+    write( log_scratch_space, * ) "field_out inner product = ", field_out_inner_prod
+    call log_event( log_scratch_space, log_level_debug )
+    field1_in_sf = 1.0_r_def / (field1_in_inner_prod + eps)
+    field2_in_sf = 1.0_r_def / (field2_in_inner_prod + eps)
+    field_out_sf = 1.0_r_def / (field_out_inner_prod + eps)
     inner1 = 0.0_r_def
-    inner1 = inner1 + n * n
-    inner1 = inner1 + n1 * n1
-    inner1 = inner1 + n2 * n2
-    inner1 = inner1 + field_out_inner_prod
-    inner1 = inner1 + field1_in_inner_prod
-    inner1 = inner1 + field2_in_inner_prod
+    inner1 = inner1 + field1_in_inner_prod * field1_in_sf
+    inner1 = inner1 + field2_in_inner_prod * field2_in_sf
+    inner1 = inner1 + field_out_inner_prod * field_out_sf
+    call invoke( inc_a_times_X( field1_in_sf, field1_in ), &
+                 inc_a_times_X( field2_in_sf, field2_in ), &
+                 inc_a_times_X( field_out_sf, field_out ) )
     field_out_field_out_input_inner_prod = 0.0_r_def
     field1_in_field1_in_input_inner_prod = 0.0_r_def
     field2_in_field2_in_input_inner_prod = 0.0_r_def
@@ -84,9 +99,6 @@
 &x_innerproduct_y(field1_in_field1_in_input_inner_prod, field1_in, field1_in_input), &
 &x_innerproduct_y(field2_in_field2_in_input_inner_prod, field2_in, field2_in_input))
     inner2 = 0.0_r_def
-    inner2 = inner2 + n * n_input
-    inner2 = inner2 + n1 * n1_input
-    inner2 = inner2 + n2 * n2_input
     inner2 = inner2 + field_out_field_out_input_inner_prod
     inner2 = inner2 + field1_in_field1_in_input_inner_prod
     inner2 = inner2 + field2_in_field2_in_input_inner_prod
