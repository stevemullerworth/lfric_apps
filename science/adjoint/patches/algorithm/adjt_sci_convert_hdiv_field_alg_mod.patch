@@ -8,10 +8,10 @@
     use function_space_mod, only : function_space_type
     use mesh_mod, only : mesh_type
     use function_space_collection_mod, only : function_space_collection
-    use convert_hdiv_field_kernel_mod, only : convert_hdiv_field_kernel_type
-    use adj_convert_hdiv_field_kernel_mod, only : adj_convert_hdiv_field_kernel_type
+    use sci_convert_hdiv_field_kernel_mod, only : convert_hdiv_field_kernel_type
+    use adj_sci_convert_hdiv_field_kernel_mod, only : adj_convert_hdiv_field_kernel_type
     use finite_element_config_mod, only : element_order_h, element_order_v
-    use fs_continuity_mod, only : w0, w3
+    use fs_continuity_mod, only : w0, w3, w2
     use constants_mod, only : i_def, r_def
     use setop_random_kernel_mod, only : setop_random_kernel_type
     use log_mod, only : log_event, log_level_error, log_level_info, log_scratch_space
@@ -24,20 +24,13 @@
     type(field_type), dimension(3) :: physical_field3
     type(field_type) :: computational_field
-    type(field_type), dimension(3) :: chi3
-    type(field_type) :: panel_id_1
     type(field_type), dimension(3) :: physical_field3_input
     type(field_type) :: computational_field_input
-    type(field_type), dimension(3) :: chi3_input
-    type(field_type) :: panel_id_1_input
     real(kind=r_def), dimension(3) :: physical_field3_inner_prod
     real(kind=r_def) :: computational_field_inner_prod
-    real(kind=r_def), dimension(3) :: chi3_inner_prod
-    real(kind=r_def) :: panel_id_1_inner_prod
     real(kind=r_def) :: inner1
     real(kind=r_def), dimension(3) :: physical_field3_physical_field3_input_inner_prod
     real(kind=r_def) :: computational_field_computational_field_input_inner_prod
-    real(kind=r_def), dimension(3) :: chi3_chi3_input_inner_prod
-    real(kind=r_def) :: panel_id_1_panel_id_1_input_inner_prod
+    TYPE(function_space_type), POINTER :: vector_space_w2_ptr
     real(kind=r_def) :: inner2
     real(kind=r_def) :: MachineTol
     real(kind=r_def) :: relative_diff
@@ -47,76 +40,50 @@
     call physical_field3(1_i_def)%initialise(vector_space=vector_space_w0_ptr, name='physical_field3')
     call physical_field3(2_i_def)%initialise(vector_space=vector_space_w0_ptr, name='physical_field3')
     call physical_field3(3_i_def)%initialise(vector_space=vector_space_w0_ptr, name='physical_field3')
-    call computational_field%initialise(vector_space=vector_space_w0_ptr, name='computational_field')
-    call chi3(1_i_def)%initialise(vector_space=vector_space_w0_ptr, name='chi3')
-    call chi3(2_i_def)%initialise(vector_space=vector_space_w0_ptr, name='chi3')
-    call chi3(3_i_def)%initialise(vector_space=vector_space_w0_ptr, name='chi3')
-    call panel_id_1%initialise(vector_space=vector_space_w3_ptr, name='panel_id_1')
-    call physical_field3_input(1_i_def)%initialise(vector_space=vector_space_w0_ptr, name='physical_field3_input')
-    call physical_field3_input(2_i_def)%initialise(vector_space=vector_space_w0_ptr, name='physical_field3_input')
-    call physical_field3_input(3_i_def)%initialise(vector_space=vector_space_w0_ptr, name='physical_field3_input')
-    call computational_field_input%initialise(vector_space=vector_space_w0_ptr, name='computational_field_input')
-    call chi3_input(1_i_def)%initialise(vector_space=vector_space_w0_ptr, name='chi3_input')
-    call chi3_input(2_i_def)%initialise(vector_space=vector_space_w0_ptr, name='chi3_input')
-    call chi3_input(3_i_def)%initialise(vector_space=vector_space_w0_ptr, name='chi3_input')
-    call panel_id_1_input%initialise(vector_space=vector_space_w3_ptr, name='panel_id_1_input')
+    vector_space_w2_ptr => function_space_collection % get_fs(mesh, element_order_h, element_order_v, w2)
+    call physical_field3(1_i_def)%initialise(vector_space=vector_space_w2_ptr, name='physical_field3')
+    call physical_field3(2_i_def)%initialise(vector_space=vector_space_w2_ptr, name='physical_field3')
+    call physical_field3(3_i_def)%initialise(vector_space=vector_space_w2_ptr, name='physical_field3')
+    call computational_field%initialise(vector_space=vector_space_w2_ptr, name='computational_field')
+    call physical_field3_input(1_i_def)%initialise(vector_space=vector_space_w2_ptr, name='physical_field3_input')
+    call physical_field3_input(2_i_def)%initialise(vector_space=vector_space_w2_ptr, name='physical_field3_input')
+    call physical_field3_input(3_i_def)%initialise(vector_space=vector_space_w2_ptr, name='physical_field3_input')
+    call computational_field_input%initialise(vector_space=vector_space_w2_ptr, name='computational_field_input')
     physical_field3_inner_prod(1_i_def) = 0.0_r_def
     physical_field3_inner_prod(2_i_def) = 0.0_r_def
     physical_field3_inner_prod(3_i_def) = 0.0_r_def
     computational_field_inner_prod = 0.0_r_def
-    chi3_inner_prod(1_i_def) = 0.0_r_def
-    chi3_inner_prod(2_i_def) = 0.0_r_def
-    chi3_inner_prod(3_i_def) = 0.0_r_def
-    panel_id_1_inner_prod = 0.0_r_def
     ! Initialise arguments and call the tangent-linear kernel.
     call invoke(setval_random(physical_field3(1_i_def)), setval_x(physical_field3_input(1_i_def), physical_field3(1_i_def)), &
 &setval_random(physical_field3(2_i_def)), setval_x(physical_field3_input(2_i_def), physical_field3(2_i_def)), &
 &setval_random(physical_field3(3_i_def)), setval_x(physical_field3_input(3_i_def), physical_field3(3_i_def)), &
-&setval_random(computational_field), setval_x(computational_field_input, computational_field), setval_random(chi3(1_i_def)), &
-&setval_x(chi3_input(1_i_def), chi3(1_i_def)), setval_random(chi3(2_i_def)), setval_x(chi3_input(2_i_def), chi3(2_i_def)), &
-&setval_random(chi3(3_i_def)), setval_x(chi3_input(3_i_def), chi3(3_i_def)), setval_random(panel_id_1), setval_x(panel_id_1_input, &
-&panel_id_1), convert_hdiv_field_kernel_type(physical_field3, computational_field, chi3, panel_id_1), &
+&setval_random(computational_field), setval_x(computational_field_input, computational_field), &
+&convert_hdiv_field_kernel_type(physical_field3, computational_field, chi, panel_id), &
 &x_innerproduct_x(physical_field3_inner_prod(1_i_def), physical_field3(1_i_def)), &
 &x_innerproduct_x(physical_field3_inner_prod(2_i_def), physical_field3(2_i_def)), &
 &x_innerproduct_x(physical_field3_inner_prod(3_i_def), physical_field3(3_i_def)), x_innerproduct_x(computational_field_inner_prod, &
-&computational_field), x_innerproduct_x(chi3_inner_prod(1_i_def), chi3(1_i_def)), x_innerproduct_x(chi3_inner_prod(2_i_def), &
-&chi3(2_i_def)), x_innerproduct_x(chi3_inner_prod(3_i_def), chi3(3_i_def)), x_innerproduct_x(panel_id_1_inner_prod, panel_id_1))
+&computational_field))
     inner1 = 0.0_r_def
     inner1 = inner1 + physical_field3_inner_prod(1_i_def)
     inner1 = inner1 + physical_field3_inner_prod(2_i_def)
     inner1 = inner1 + physical_field3_inner_prod(3_i_def)
     inner1 = inner1 + computational_field_inner_prod
-    inner1 = inner1 + chi3_inner_prod(1_i_def)
-    inner1 = inner1 + chi3_inner_prod(2_i_def)
-    inner1 = inner1 + chi3_inner_prod(3_i_def)
-    inner1 = inner1 + panel_id_1_inner_prod
     physical_field3_physical_field3_input_inner_prod(1_i_def) = 0.0_r_def
     physical_field3_physical_field3_input_inner_prod(2_i_def) = 0.0_r_def
     physical_field3_physical_field3_input_inner_prod(3_i_def) = 0.0_r_def
     computational_field_computational_field_input_inner_prod = 0.0_r_def
-    chi3_chi3_input_inner_prod(1_i_def) = 0.0_r_def
-    chi3_chi3_input_inner_prod(2_i_def) = 0.0_r_def
-    chi3_chi3_input_inner_prod(3_i_def) = 0.0_r_def
-    panel_id_1_panel_id_1_input_inner_prod = 0.0_r_def
-    call invoke(adj_convert_hdiv_field_kernel_type(physical_field3, computational_field, chi3, panel_id_1), &
+    call invoke(adj_convert_hdiv_field_kernel_type(physical_field3, computational_field, chi, panel_id), &
 &x_innerproduct_y(physical_field3_physical_field3_input_inner_prod(1_i_def), physical_field3(1_i_def), &
 &physical_field3_input(1_i_def)), x_innerproduct_y(physical_field3_physical_field3_input_inner_prod(2_i_def), &
 &physical_field3(2_i_def), physical_field3_input(2_i_def)), &
 &x_innerproduct_y(physical_field3_physical_field3_input_inner_prod(3_i_def), physical_field3(3_i_def), &
 &physical_field3_input(3_i_def)), x_innerproduct_y(computational_field_computational_field_input_inner_prod, computational_field, &
-&computational_field_input), x_innerproduct_y(chi3_chi3_input_inner_prod(1_i_def), chi3(1_i_def), chi3_input(1_i_def)), &
-&x_innerproduct_y(chi3_chi3_input_inner_prod(2_i_def), chi3(2_i_def), chi3_input(2_i_def)), &
-&x_innerproduct_y(chi3_chi3_input_inner_prod(3_i_def), chi3(3_i_def), chi3_input(3_i_def)), &
-&x_innerproduct_y(panel_id_1_panel_id_1_input_inner_prod, panel_id_1, panel_id_1_input))
+&computational_field_input))
     inner2 = 0.0_r_def
     inner2 = inner2 + physical_field3_physical_field3_input_inner_prod(1_i_def)
     inner2 = inner2 + physical_field3_physical_field3_input_inner_prod(2_i_def)
     inner2 = inner2 + physical_field3_physical_field3_input_inner_prod(3_i_def)
     inner2 = inner2 + computational_field_computational_field_input_inner_prod
-    inner2 = inner2 + chi3_chi3_input_inner_prod(1_i_def)
-    inner2 = inner2 + chi3_chi3_input_inner_prod(2_i_def)
-    inner2 = inner2 + chi3_chi3_input_inner_prod(3_i_def)
-    inner2 = inner2 + panel_id_1_panel_id_1_input_inner_prod
     ! Test the inner-product values for equality, allowing for the precision of the active variables
     MachineTol = SPACING(MAX(ABS(inner1), ABS(inner2)))
     relative_diff = ABS(inner1 - inner2) / MachineTol
