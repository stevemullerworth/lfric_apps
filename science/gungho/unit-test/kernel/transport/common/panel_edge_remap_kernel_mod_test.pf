!-----------------------------------------------------------------------------
! (C) Crown copyright 2025 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> Test the remapping of scalar fields on the cubed-sphere panel extension
module panel_edge_remap_kernel_mod_test

  use constants_mod, only: l_def, i_def, r_tran, r_def, IMDI
  use funit

  implicit none

  private
  public :: test_all

  @TestCase
  type, extends(TestCase), public :: panel_edge_remap_test_type
    private
  contains
    procedure test_all
  end type panel_edge_remap_test_type

contains

  @Test
  subroutine test_all( this )

    use panel_edge_remap_kernel_mod, only: panel_edge_remap_code
    use coord_transform_mod,               only: alphabetar2llr

    implicit none

    class(panel_edge_remap_test_type), intent(inout) :: this

    real(kind=r_tran), parameter :: tol = 1.0e-5_r_tran

    integer(kind=i_def), parameter :: nlayers = 1
    integer(kind=i_def), parameter :: ndata = 4
    integer(kind=i_def), parameter :: ncells = 6
    integer(kind=i_def), parameter :: ndf_ws = 1
    integer(kind=i_def), parameter :: undf_ws = ncells*ndf_ws*nlayers
    integer(kind=i_def), parameter :: ndf_pid = 1
    integer(kind=i_def), parameter :: undf_pid = 1
    integer(kind=i_def), parameter :: ndf_wr = 1
    integer(kind=i_def), parameter :: undf_wr = ncells*ndf_ws*nlayers
    integer(kind=i_def), parameter :: ndf_ww = 1
    integer(kind=i_def), parameter :: undf_ww = ndf_ww*ndata
    integer(kind=i_def), parameter :: depth = 1
    logical(kind=l_def), parameter :: compute_all_halo = .false.

    integer(kind=i_def)            :: map_ww(ndf_ww)
    integer(kind=i_def)            :: map_ws(ndf_ws)
    integer(kind=i_def)            :: map_wr(ndf_wr)
    integer(kind=i_def)            :: map_pid(ndf_pid)

    integer(kind=i_def)            :: stencil_size(4)
    integer(kind=i_def), parameter :: max_length = 3
    integer(kind=i_def)            :: stencil(ndf_ws, max_length, 4)

    real(kind=r_tran)              :: remapped_field_x(undf_wr)
    real(kind=r_tran)              :: remapped_field_y(undf_wr)
    real(kind=r_tran)              :: field(undf_ws)
    real(kind=r_tran)              :: panel_edge_weights_x(undf_ww)
    real(kind=r_tran)              :: panel_edge_weights_y(undf_ww)
    integer(kind=i_def)            :: panel_edge_indices_x(undf_ww)
    integer(kind=i_def)            :: panel_edge_indices_y(undf_ww)
    integer(kind=i_def)            :: panel_edge_dist_W(undf_pid)
    integer(kind=i_def)            :: panel_edge_dist_E(undf_pid)
    integer(kind=i_def)            :: panel_edge_dist_S(undf_pid)
    integer(kind=i_def)            :: panel_edge_dist_N(undf_pid)
    integer(kind=i_def)            :: halo_mask_x(undf_pid)
    integer(kind=i_def)            :: halo_mask_y(undf_pid)

    real(kind=r_tran)   :: minvalue
    logical(kind=l_def) :: monotone
    logical(kind=l_def) :: enforce_minvalue

    ! Remap from panel 2 to panel 1
    stencil_size(1) = 2
    stencil_size(2) = 3
    stencil_size(3) = 1
    stencil_size(4) = 3

    ! Stencil shape is:
    !     | 6 |
    !     | 5 |
    ! | 2 | 1 |
    !     | 3 |
    !     | 4 |

    map_ws(1) = 1
    stencil(1,1,:) = map_ws(1)
    stencil(1,2,1) = 2
    stencil(1,2,2) = 3
    stencil(1,2,3) = -1
    stencil(1,2,4) = 5
    stencil(1,3,2) = 4
    stencil(1,3,4) = 6

    map_wr(1) = 1
    map_pid(1) = 1
    map_ww(1) = 1

    panel_edge_dist_W(1) = 1
    panel_edge_dist_E(1) = -ABS(IMDI)
    panel_edge_dist_N(1) = -ABS(IMDI)
    panel_edge_dist_S(1) = -ABS(IMDI)
    halo_mask_x(:) = 0
    halo_mask_y(:) = 0

    ! Don't do anything in y direction
    panel_edge_weights_y(:) = 0.0_r_tran
    panel_edge_indices_y(:) = 0

    ! Set field, pick cubic shape: 2 - 3*x + x**2 - x**3
    ! Let field points be at (-3, -1, 1, 3, 5)
    field(:) = -61.0_r_tran
    field(3) = 3.0_r_tran
    field(1) = 3.0_r_tran
    field(5) = 83.0_r_tran
    field(6) = 387.0_r_tran

    ! Consider remapping to x = 0. This gives coefficients
    panel_edge_weights_x(1) = -0.0625_r_tran
    panel_edge_weights_x(2) = 0.5625_r_tran
    panel_edge_weights_x(3) = 0.5625_r_tran
    panel_edge_weights_x(4) = -0.0625_r_tran
    panel_edge_indices_x(1) = 3
    panel_edge_indices_x(2) = 2
    panel_edge_indices_x(3) = 1
    panel_edge_indices_x(4) = 4

    remapped_field_x(:) = 0.0_r_tran
    remapped_field_y(:) = 0.0_r_tran

    monotone = .false.
    enforce_minvalue = .false.
    minvalue = 0.0_r_tran

    call panel_edge_remap_code( nlayers,                                       &
                                remapped_field_x, remapped_field_y,            &
                                field,                                         &
                                stencil_size, max_length, stencil,             &
                                field,                                         &
                                stencil_size, max_length, stencil,             &
                                panel_edge_weights_x, panel_edge_weights_y,    &
                                panel_edge_indices_x, panel_edge_indices_y,    &
                                panel_edge_dist_W, panel_edge_dist_E,          &
                                panel_edge_dist_S, panel_edge_dist_N,          &
                                halo_mask_x, halo_mask_y,                      &
                                compute_all_halo,                              &
                                depth,                                         &
                                ndata, monotone, enforce_minvalue, minvalue,   &
                                ndf_wr, undf_wr, map_wr,                       &
                                ndf_ws, undf_ws, map_ws,                       &
                                ndf_ww, undf_ww, map_ww,                       &
                                ndf_pid, undf_pid, map_pid                     &
    )

    @assertEqual(2.0_r_tran, remapped_field_x(1), tol)

    ! Test enforcement of min value
    monotone = .false.
    enforce_minvalue = .true.
    minvalue = 2.5_r_tran

    call panel_edge_remap_code( nlayers,                                       &
                                remapped_field_x, remapped_field_y,            &
                                field,                                         &
                                stencil_size, max_length, stencil,             &
                                field,                                         &
                                stencil_size, max_length, stencil,             &
                                panel_edge_weights_x, panel_edge_weights_y,    &
                                panel_edge_indices_x, panel_edge_indices_y,    &
                                panel_edge_dist_W, panel_edge_dist_E,          &
                                panel_edge_dist_S, panel_edge_dist_N,          &
                                halo_mask_x, halo_mask_y,                      &
                                compute_all_halo,                              &
                                depth,                                         &
                                ndata, monotone, enforce_minvalue, minvalue,   &
                                ndf_wr, undf_wr, map_wr,                       &
                                ndf_ws, undf_ws, map_ws,                       &
                                ndf_ww, undf_ww, map_ww,                       &
                                ndf_pid, undf_pid, map_pid                     &
    )

    @assertEqual(minvalue, remapped_field_x(1), tol)

    ! Test monotonicity
    monotone = .true.
    enforce_minvalue = .false.

    ! Set field, pick quadratic shape: 2 + x**2
    ! Let field points be at (-3, -1, 1, 3, 5)
    field(:) = 11.0_r_tran
    field(3) = 3.0_r_tran
    field(1) = 3.0_r_tran
    field(5) = 11.0_r_tran
    field(6) = 26.0_r_tran

    call panel_edge_remap_code( nlayers,                                       &
                                remapped_field_x, remapped_field_y,            &
                                field,                                         &
                                stencil_size, max_length, stencil,             &
                                field,                                         &
                                stencil_size, max_length, stencil,             &
                                panel_edge_weights_x, panel_edge_weights_y,    &
                                panel_edge_indices_x, panel_edge_indices_y,    &
                                panel_edge_dist_W, panel_edge_dist_E,          &
                                panel_edge_dist_S, panel_edge_dist_N,          &
                                halo_mask_x, halo_mask_y,                      &
                                compute_all_halo,                              &
                                depth,                                         &
                                ndata, monotone, enforce_minvalue, minvalue,   &
                                ndf_wr, undf_wr, map_wr,                       &
                                ndf_ws, undf_ws, map_ws,                       &
                                ndf_ww, undf_ww, map_ww,                       &
                                ndf_pid, undf_pid, map_pid                     &
    )

    @assertEqual(3.0_r_tran, remapped_field_x(1), tol)


  end subroutine test_all

end module panel_edge_remap_kernel_mod_test
