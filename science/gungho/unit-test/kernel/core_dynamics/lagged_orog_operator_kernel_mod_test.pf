!-----------------------------------------------------------------------------
! (c) Crown copyright 2022 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> @brief Test the lagged orography operator computation
!>
module lagged_orog_operator_kernel_mod_test

    use constants_mod, only : i_def, r_def
    use get_unit_test_m3x3_q3x3x3_sizes_mod, &
      only : get_w2_m3x3_q3x3x3_size
    use pFUnit_Mod

  implicit none

  private
  public :: test_all

  @TestCase
  type, extends(TestCase), public :: lagged_orog_operator_test_type
    private
  contains
    procedure setUp
    procedure tearDown
    procedure test_all
  end type lagged_orog_operator_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    use finite_element_config_mod, only : cellshape_quadrilateral, &
                                          coord_system_xyz
    use feign_config_mod,          only : feign_finite_element_config

    implicit none

    class(lagged_orog_operator_test_type), intent(inout) :: this

    call feign_finite_element_config(      &
      cellshape=cellshape_quadrilateral,   &
      coord_order=0_i_def,                 &
      coord_system=coord_system_xyz,       &
      element_order_h=1_i_def,             &
      element_order_v=1_i_def,             &
      rehabilitate=.true., vorticity_in_w1=.false. )

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    implicit none

    class(lagged_orog_operator_test_type), intent(inout) :: this

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @Test
  subroutine test_all( this )

    use lagged_orog_operator_kernel_mod, only : lagged_orog_operator_kernel_code

    implicit none

    class(lagged_orog_operator_test_type), intent(inout) :: this

    real(r_def), parameter :: tol = 1.0e-12_r_def
    integer(i_def), parameter :: nlayers = 3

    integer :: cell
    integer(i_def) :: unused

    integer(i_def) :: ndf_w2, undf_w2
    integer(i_def) :: ncells, ncell_3d

    real(r_def), allocatable :: m_w2(:,:,:)
    real(r_def), allocatable :: lagged_m_w2(:,:,:)

    real(r_def) :: answer(6, 6)

    call get_w2_m3x3_q3x3x3_size( ndf_w2, undf_w2, ncells, &
                                  unused, unused, &
                                  unused, unused, nlayers=nlayers )

    ! Test the operator kernel
    ncell_3d = ncells * nlayers
    allocate( m_w2(ncell_3d, ndf_w2, ndf_w2) )
    allocate( lagged_m_w2(ncell_3d, ndf_w2, ndf_w2) )
    m_w2 = 2.0_r_def

    cell = 1

    call lagged_orog_operator_kernel_code( cell,        &
                                           nlayers,     &
                                           ncell_3d,    &
                                           lagged_m_w2, &
                                           ncell_3d,    &
                                           m_w2,        &
                                           ndf_w2 )

    ! Given the inputs prepared above the result should be as follows.
    ! (Generated by a supposed successful run of this test)
    answer = reshape( [2.00_r_def, &
                       2.00_r_def, &
                       2.00_r_def, &
                       2.00_r_def, &
                       0.00_r_def, &
                       0.00_r_def, &
                       !
                       2.00_r_def, &
                       2.00_r_def, &
                       2.00_r_def, &
                       2.00_r_def, &
                       0.00_r_def, &
                       0.00_r_def, &
                       !
                       2.00_r_def, &
                       2.00_r_def, &
                       2.00_r_def, &
                       2.00_r_def, &
                       0.00_r_def, &
                       0.00_r_def, &
                       !
                       2.00_r_def, &
                       2.00_r_def, &
                       2.00_r_def, &
                       2.00_r_def, &
                       0.00_r_def, &
                       0.00_r_def, &
                       !
                       0.00_r_def, &
                       0.00_r_def, &
                       0.00_r_def, &
                       0.00_r_def, &
                       2.00_r_def, &
                       2.00_r_def, &
                       !
                       0.00_r_def, &
                       0.00_r_def, &
                       0.00_r_def, &
                       0.00_r_def, &
                       2.00_r_def, &
                       2.00_r_def ], shape(answer) )

    @assertEqual( answer, lagged_m_w2(1, :, :), tol )

    deallocate( m_w2, lagged_m_w2 )

  end subroutine test_all

end module lagged_orog_operator_kernel_mod_test
